window.addEventListener("load",(function(){!function(){"use strict";var glgObj={time:0,tchr:"",clss:"",frag:"",voca:[],qstns:[]};function signOutOfApp(){firebase.auth().signOut()}function mod_quizgame(questions){var stage,score=0,particles=[],gameObjects=[],images=["images/planet.png","images/ship.png","images/enemy.png","images/enemystem.png","images/enemychoice.png","images/enemystemselected.png","images/enemychoiceselected.png","images/laser.png","images/enemylaser.png"],imagesLoaded=0,loaded=!1,playing=!1,player,planet,level=-1,displayRect={x:0,y:0,width:0,height:0},question="",interval,enemySpeed,touchDown=!1,mouseDown=!1,currentTeam=[],lastShot=0,currentPointsLeft=0,context,inFullscreen=0;function playSound(soundName){var soundElement=document.getElementById("mod_quizgame_sound_"+soundName);soundElement.currentTime=0,soundElement.play()}function smallscreen(){stage.removeAttribute("width"),stage.removeAttribute("height"),stage.removeAttribute("style"),displayRect.width=stage.clientWidth,displayRect.height=stage.clientHeight,stage.style.width=displayRect.width,stage.style.height=displayRect.height,sizeScreen(stage)}function fschange(){--inFullscreen<1&&smallscreen()}function fullscreen(){displayRect.width=window.screen.width||stage.clientWidth,displayRect.height=window.screen.height||stage.clientHeight,stage.requestFullscreen?stage.requestFullscreen():stage.msRequestFullscreen?stage.msRequestFullscreen():stage.mozRequestFullScreen?stage.mozRequestFullScreen():stage.webkitRequestFullscreen&&stage.webkitRequestFullscreen(),inFullscreen=2,stage.style.width=screen.width+"px",stage.style.height="100%",sizeScreen(stage)}function sizeScreen(stage){stage.width=displayRect.width,stage.height=displayRect.height,context.imageSmoothingEnabled=!1}function clearEvents(){document.onkeydown=null,document.onkeyup=null,document.onmousedown=null,document.onmouseup=null,document.onmousemove=null,document.ontouchstart=null,document.ontouchend=null,document.ontouchmove=null}function menuEvents(){clearEvents(),document.onkeydown=menukeydown,document.onmouseup=menumousedown}function showMenu(){context.clearRect(0,0,displayRect.width,displayRect.height),context.fillStyle="#ffffff",context.font="22px Audiowide",context.textAlign="center",null!==questions&&questions.length?(context.fillText("Hit Spacebar to Start",displayRect.width/2,displayRect.height/2),menuEvents()):context.fillText("데이터가 없습니다!",displayRect.width/2,displayRect.height/2)}function loadGame(e){shuffle(questions),loaded?startGame():(images.forEach((function(src){var image=new Image;image.src=src,image.onload=function(){++imagesLoaded>=images.length&&gameLoaded()}})),loaded=!0)}function endGame(score){menuEvents(),userScored(score)}function gameLoaded(){playing=!0,clearInterval(interval),interval=setInterval((function(){draw(context,displayRect,gameObjects,particles,question),update(displayRect,gameObjects,particles)}),40),startGame()}function startGame(){glgObj.time=Date.now(),score=0,gameObjects=[],particles=[],level=-1,enemySpeed=.5,touchDown=!1,mouseDown=!1,(player=new Player("images/ship.png",0,0)).x=displayRect.width/2,player.y=displayRect.height/2,gameObjects.push(player),(planet=new Planet("images/planet.png",0,0)).image.width=displayRect.width,planet.image.height=displayRect.height,planet.direction.y=1,planet.movespeed.y=.7,particles.push(planet),nextLevel(),document.onkeyup=keyup,document.onkeydown=keydown,document.onmouseup=mouseup,document.onmousedown=mousedown,document.onmousemove=mousemove,document.ontouchstart=touchstart,document.ontouchend=touchend,document.ontouchmove=touchmove}function nextLevel(){++level>=questions.length&&(level=0,enemySpeed*=1.3),question=runLevel(questions,level,displayRect)}function runLevel(questions,level,bounds){if(currentTeam=[],lastShot=0,currentPointsLeft=0,"multichoice"==questions[level].type)questions[level].answers.forEach((function(answer){var enemy=new MultiEnemy(Math.random()*bounds.width,-Math.random()*bounds.height/2,answer.text,answer.fraction);answer.fraction<1&&(currentTeam.push(enemy),answer.fraction>0&&(currentPointsLeft+=answer.fraction)),gameObjects.push(enemy)}));else if("match"==questions[level].type){var i=0,fraction=1/questions[level].stems.length;currentPointsLeft+=1,questions[level].stems.forEach((function(stem){i++;var question=new MatchEnemy(Math.random()*bounds.width,-Math.random()*bounds.height/2,stem.question,fraction,-i,!0),answer=new MatchEnemy(Math.random()*bounds.width,-Math.random()*bounds.height/2,stem.answer,fraction,i);currentTeam.push(question),currentTeam.push(answer),gameObjects.push(question),gameObjects.push(answer)}))}return questions[level].question}function draw(context,displayRect,objects,particles,question){context.clearRect(0,0,displayRect.width,displayRect.height);for(var i=0;i<particles.length;i++)particles[i].draw(context);for(i=0;i<objects.length;i++)objects[i].draw(context);player.alive?(context.fillStyle="#ffffff",context.font="20px Audiowide",context.textAlign="left",context.fillText("Score: "+Math.round(score)+" Lives: "+player.lives,5,20),context.textAlign="center",context.font="28px Audiowide",context.fillText(question,displayRect.width/2,28)):(context.fillStyle="#FFFFFF",context.font="20px Audiowide",context.textAlign="center",context.fillText("Game Over! Score: "+Math.round(player.lastScore),displayRect.width/2,displayRect.height/2))}function update(bounds,objects,particles){for(var i=0;i<3;i++)particles.push(new Star(bounds));for(i=0;i<particles.length;i++)particles[i].update(bounds),particles[i].alive||(particles.splice(i,1),i--);for(i=0;i<objects.length;i++){objects[i].update(bounds);for(var j=i+1;j<objects.length;j++)collide(objects[i],objects[j]);objects[i].alive||(objects.splice(i,1),i--)}}function Rectangle(left,top,width,height){this.left=left||0,this.top=top||0,this.width=width||0,this.height=height||0}function GameObject(src,x,y){null!==src&&(this.image=this.loadImage(src)),this.x=x,this.y=y,this.velocity={x:0,y:0},this.direction={x:0,y:0},this.movespeed={x:5,y:3},this.alive=!0,this.decay=.7}function Player(src,x,y){GameObject.call(this,src,x,y),this.mouse={x:0,y:0},this.movespeed={x:6,y:4},this.lives=3,this.lastScore=0}function Planet(src,x,y){GameObject.call(this,src,x,y)}function Enemy(src,x,y,text,fraction){GameObject.call(this,src,x,y),this.xspeed=enemySpeed,this.yspeed=enemySpeed*(2+Math.random())/4,this.movespeed.x=0,this.movespeed.y=0,this.direction.y=1,this.text=text,this.fraction=fraction,this.movementClock=0,this.shotFrequency=80,this.shotClock=(1+Math.random())*this.shotFrequency,this.level=level}function MultiEnemy(x,y,text,fraction){Enemy.call(this,"images/enemy.png",x,y,text,fraction)}function MatchEnemy(x,y,text,fraction,pairid,stem){this.stem=!!stem,this.stem?Enemy.call(this,"images/enemystem.png",x,y,text,fraction):Enemy.call(this,"images/enemychoice.png",x,y,text,fraction),this.pairid=pairid,this.shotFrequency=160,this.hightlighted=!1}function Laser(x,y,friendly,laserSpeed){GameObject.call(this,friendly?"images/laser.png":"images/enemylaser.png",x,y),this.direction.y=-1,this.friendly=friendly?1:0,this.laserSpeed=laserSpeed||12}function Particle(x,y,velocity,colour){GameObject.call(this,null,x,y),this.width=2,this.height=2,this.velocity.x=velocity.x,this.velocity.y=velocity.y,this.aliveTime=0,this.colour=colour,this.decay=1}function Star(bounds){GameObject.call(this,null,Math.random()*bounds.width,0),this.width=2,this.height=2,this.direction.y=1,this.movespeed.y=.2+Math.random()/2,this.aliveTime=0}function collide(object1,object2){return object1.alive&&object2.alive&&(collide_ordered(object1,object2)||collide_ordered(object2,object1))}function collide_ordered(object1,object2){return object1 instanceof Laser&&object2 instanceof Player&&!object1.friendly&&objectsIntersect(object1,object2)?(object2.gotShot(object1),object1.die(),!0):object1 instanceof Laser&&object2 instanceof Enemy&&object1.friendly&&objectsIntersect(object1,object2)?(object2.gotShot(object1),!0):object1 instanceof Player&&object2 instanceof Enemy&&objectsIntersect(object1,object2)?(object1.die(),!0):void 0}function objectsIntersect(object1,object2){var rect1=object1.getRect(),rect2=object2.getRect();return rect1.Intersect(rect2)}function spray(x,y,num,colour){for(var i=0;i<num;i++)particles.push(new Particle(x,y,{x:16*(Math.random()-.5),y:16*(Math.random()-.5)+3},colour))}document.getElementById("mod_quizgame_fullscreen_button").addEventListener("click",(function(){fullscreen()})),Rectangle.prototype.right=function(){return this.left+this.width},Rectangle.prototype.bottom=function(){return this.top+this.height},Rectangle.prototype.Contains=function(point){return point.x>this.left&&point.x<this.right()&&point.y>this.top&&point.y<this.bottom()},Rectangle.prototype.Intersect=function(rectangle){var retval;return!(rectangle.left>this.right()||rectangle.right()<this.left||rectangle.top>this.bottom()||rectangle.bottom()<this.top)},GameObject.prototype.loadImage=function(src){return this.image||(this.image=new Image),this.image.src=src,this.image},GameObject.prototype.update=function(){this.velocity.x+=this.direction.x*this.movespeed.x,this.velocity.y+=this.direction.y*this.movespeed.y,this.x+=this.velocity.x,this.y+=this.velocity.y,this.velocity.y*=this.decay,this.velocity.x*=this.decay},GameObject.prototype.draw=function(context){context.drawImage(this.image,this.x,this.y,this.image.width,this.image.height)},GameObject.prototype.getRect=function(){return new Rectangle(this.x,this.y,this.image.width,this.image.height)},GameObject.prototype.die=function(){this.alive=!1},Player.prototype=Object.create(GameObject.prototype),Player.prototype.update=function(bounds){(mouseDown||touchDown)&&(this.x<this.mouse.x-this.image.width?player.direction.x=1:this.x>this.mouse.x?player.direction.x=-1:player.direction.x=0,this.y<this.mouse.y-this.image.height?player.direction.y=1:this.y>this.mouse.y?player.direction.y=-1:player.direction.y=0),GameObject.prototype.update.call(this,bounds),this.x<bounds.x-this.image.width?this.x=bounds.width:this.x>bounds.width&&(this.x=bounds.x-this.image.width),this.y<bounds.y?this.y=bounds.y:this.y>bounds.height-this.image.height&&(this.y=bounds.height-this.image.height)},Player.prototype.Shoot=function(){playSound("laser"),gameObjects.unshift(new Laser(player.x,player.y,!0,24)),canShoot=!1},Player.prototype.die=function(){GameObject.prototype.die.call(this),playSound("explosion"),spray(this.x+this.image.width/2,this.y+this.image.height/2,200,"#ffcc00"),this.lastScore=score,endGame(score)},Player.prototype.gotShot=function(shot){shot.alive&&(this.lives<=1?this.die():(this.lives--,spray(this.x+this.image.width/2,this.y+this.image.height/2,100,"#ffcc00")))},Planet.prototype=Object.create(GameObject.prototype),Planet.prototype.update=function(bounds){planet.image.width=displayRect.width,planet.image.height=displayRect.height,GameObject.prototype.update.call(this,bounds)},Enemy.prototype=Object.create(GameObject.prototype),Enemy.prototype.update=function(bounds){if(this.y<bounds.height/10||this.y>9*bounds.height/10?(this.movespeed.x=1*this.xspeed,this.movespeed.y=5*this.yspeed):(this.movespeed.x=this.xspeed,this.movespeed.y=this.yspeed),GameObject.prototype.update.call(this,bounds),this.movementClock--,this.movementClock<=0&&(this.direction.x=Math.floor(3*Math.random())-1,this.movementClock=30*(2+Math.random())),this.shotClock-=enemySpeed,this.shotClock<=0&&this.y<.6*bounds.height){playSound("enemylaser");var laser=new Laser(this.x,this.y);laser.direction.y=1,laser.friendly=!1,gameObjects.unshift(laser),this.shotClock=(1+Math.random())*this.shotFrequency}this.x<bounds.x-this.image.width?this.x=bounds.width:this.x>bounds.width&&(this.x=bounds.x-this.image.width),this.y>bounds.height+this.image.height&&this.alive&&(this.alive=!1,this.fraction>0&&(currentPointsLeft-=this.fraction,score-=1e3*this.fraction),currentPointsLeft<=0&&this.level==level&&player.alive&&nextLevel())},Enemy.prototype.draw=function(context){GameObject.prototype.draw.call(this,context),context.fillStyle="#ffffff",context.font="18px Audiowide",context.textAlign="center",context.fillText(this.text,this.x+this.image.width/2,this.y-5)},Enemy.prototype.die=function(){GameObject.prototype.die.call(this),spray(this.x+this.image.width,this.y+this.image.height,50+150*this.fraction,"#ff0000"),score+=1e3*this.fraction,playSound("explosion")},Enemy.prototype.gotShot=function(shot){},MultiEnemy.prototype=Object.create(Enemy.prototype),MultiEnemy.prototype.die=function(){Enemy.prototype.die.call(this),this.fraction>0&&(currentPointsLeft-=this.fraction),(this.fraction>=1||this.fraction>0&&currentPointsLeft<=0)&&(currentTeam.forEach((function(enemy){enemy.alive&&enemy.die()})),currentTeam=[],nextLevel())},MultiEnemy.prototype.gotShot=function(shot){this.fraction>0?(shot.die(),this.die()):(score+=600*(this.fraction-.5),shot.deflect())},MatchEnemy.prototype=Object.create(Enemy.prototype),MatchEnemy.prototype.die=function(){Enemy.prototype.die.call(this)},MatchEnemy.prototype.gotShot=function(shot){if(shot.alive&&this.alive)if(lastShot==-this.pairid){shot.die(),this.die();var alives=0;currentTeam.forEach((function(match){match.pairid==lastShot&&match.die(),match.alive&&alives++})),alives<=0&&nextLevel()}else lastShot==this.pairid?shot.deflect():(shot.die(),this.hightlight(),lastShot=this.pairid)},MatchEnemy.prototype.hightlight=function(){currentTeam.forEach((function(match){match.unhightlight()})),this.stem?this.loadImage("images/enemystemselected.png"):this.loadImage("images/enemychoiceselected.png"),this.hightlighted=!0},MatchEnemy.prototype.unhightlight=function(){this.hightlighted&&(this.stem?this.loadImage("images/enemystem.png"):this.loadImage("images/enemychoice.png")),this.hightlighted=!1},Laser.prototype=Object.create(GameObject.prototype),Laser.prototype.update=function(bounds){GameObject.prototype.update.call(this,bounds),(this.x<bounds.x-this.image.width||this.x>bounds.width||this.y<bounds.y-this.image.height||this.y>bounds.height)&&(this.alive=!1),this.velocity.y=this.laserSpeed*this.direction.y},Laser.prototype.deflect=function(){this.image=this.loadImage("images/enemylaser.png"),this.direction.y*=-1,this.friendly=!this.friendly,playSound("deflect")},Particle.prototype=Object.create(GameObject.prototype),Particle.prototype.update=function(bounds){GameObject.prototype.update.call(this,bounds),(this.x<bounds.x-this.width||this.x>bounds.width||this.y<bounds.y-this.height||this.y>bounds.height)&&(this.alive=!1),this.aliveTime++,this.aliveTime>15*Math.random()+5&&(this.alive=!1)},Particle.prototype.getRect=function(){return new Rectangle(this.x,this.y,this.width,this.height)},Particle.prototype.draw=function(context){context.fillStyle=this.colour,context.fillRect(this.x,this.y,this.width,this.height),context.stroke()},Star.prototype=Object.create(GameObject.prototype),Star.prototype.update=function(bounds){GameObject.prototype.update.call(this,bounds),this.y>bounds.height&&(this.alive=!1)},Star.prototype.draw=function(context){context.fillStyle="#9999aa",context.fillRect(this.x,this.y,this.width,this.height),context.stroke()};var canShoot=!0;function menukeydown(e){-1!==[32,37,38,39,40].indexOf(e.keyCode)&&(e.preventDefault(),32===e.keyCode&&loadGame(e))}function menumousedown(e){e.target===stage&&loadGame(e)}function keydown(e){-1!==[32,37,38,39,40].indexOf(e.keyCode)&&(e.preventDefault(),32===e.keyCode&&player.alive&&canShoot?player.Shoot():37===e.keyCode?player.direction.x=-1:38===e.keyCode?player.direction.y=-1:39===e.keyCode?player.direction.x=1:40===e.keyCode&&(player.direction.y=1))}function keyup(e){32===e.keyCode?canShoot=!0:-1!==[37,39].indexOf(e.keyCode)?player.direction.x=0:-1!==[38,40].indexOf(e.keyCode)&&(player.direction.y=0)}function mousedown(e){var playerWasClicked;e.target===stage&&(player.getRect().Contains({x:e.offsetX,y:e.offsetY})&&player.alive&&player.Shoot(),mouseDown||(player.mouse.x=e.offsetX,player.mouse.y=e.offsetY,mouseDown=!0))}function mouseup(){player.direction.x=0,player.direction.y=0,mouseDown=!1}function mousemove(e){player.mouse.x=e.offsetX,player.mouse.y=e.offsetY}function touchstart(e){e.target===stage&&(player.alive&&e.touches.length>1?player.Shoot():(touchDown=!0,touchmove(e)))}function touchend(e){0===e.touches.length&&(touchDown=!1),player.direction.x=0,player.direction.y=0}function touchmove(e){player.mouse.x=e.touches[0].clientX,player.mouse.y=e.touches[0].clientY-player.image.height}function shuffle(array){for(var currentIndex=array.length,temporaryValue,randomIndex;0!==currentIndex;)randomIndex=Math.floor(Math.random()*currentIndex),temporaryValue=array[currentIndex-=1],array[currentIndex]=array[randomIndex],array[randomIndex]=temporaryValue;return array}function doInitialize(){document.addEventListener&&(document.addEventListener("fullscreenchange",fschange,!1),document.addEventListener("MSFullscreenChange",fschange,!1),document.addEventListener("mozfullscreenchange",fschange,!1),document.addEventListener("webkitfullscreenchange",fschange,!1)),stage=document.getElementById("mod_quizgame_game"),context=stage.getContext("2d"),smallscreen(),interval=setInterval((function(){showMenu()}),500)}doInitialize()}function handlersOn(){navListenersOn(),docEl("chgSelected").addEventListener("click",updateClss,{capture:!1,passive:!0})}function initGame(){mod_quizgame(glgObj.qstns)}function makeGameQstns(){glgObj.qstnsMulti=[],glgObj.qstnsMatch=[],makemultiQs(),makeMatchQs(),glgObj.qstns=glgObj.qstnsMulti.concat(glgObj.qstnsMatch),glgObj.qstnsMulti=[],glgObj.qstnsMatch=[],initGame()}function getAllKr(){var krArr=glgObj.voca.map((function(el){return el.kr}));return shuffleAnArray(krArr)}function makemultiQs(){var multiQ,multiQans;glgObj.voca.forEach((function(el){(multiQ={}).question=el.en,multiQ.type="multichoice",multiQ.answers=[],(multiQans={}).text=el.kr,multiQans.fraction=1,multiQ.answers.push(multiQans),glgObj.qstnsMulti.push(multiQ)})),addDistractorsForMultiQs()}function addDistractorsForMultiQs(){var krArr=getAllKr(),multiQdis,count,i;glgObj.qstnsMulti.forEach((function(el){for(count=0,(!krArr.length||krArr.length<4)&&(krArr=getAllKr()),i=krArr.length-1;i>=0;i--)if(count<4){if(krArr[i]===el.answers[0].text)continue;(multiQdis={}).text=krArr.splice(i,1)[0],multiQdis.fraction=0,el.answers.push(multiQdis),count++}else shuffleAnArray(el.answers)}))}function makeMatchQs(){var vocaCopy=glgObj.voca.slice(0),matchQ,matchQStems,tempSplice,i,ii;for(i=vocaCopy.length-1;i>=0;i--)if(vocaCopy.length>1){for(tempSplice=vocaCopy.splice(0,2),(matchQ={}).question="Match!",matchQ.type="match",matchQ.stems=[],ii=0;ii<2;ii++)(matchQStems={}).question=tempSplice[ii].en,matchQStems.answer=tempSplice[ii].kr,matchQ.stems.push(matchQStems);glgObj.qstnsMatch.push(matchQ)}else vocaCopy.length&&(tempSplice=vocaCopy.splice(0,1),(matchQStems={}).question=tempSplice[0].en,matchQStems.answer=tempSplice[0].kr,glgObj.qstnsMatch[glgObj.qstnsMatch.length-1].stems.push(matchQStems))}function dataErrorMOD(){docEl("slctdTchrTxt").textContent="Class unknown!",mod_quizgame(glgObj.qstns)}function init(){var objExists=window.localStorage.getItem("myClss"),data=JSON.parse(objExists);if(null!==data){try{glgObj.tchr=data.tchr,glgObj.clss=data.clss,data.hasOwnProperty("frag")&&!0===chkTrk(data.frag)&&(glgObj.frag=data.frag),glgObj.voca=data.voca}catch(e){glgObj.tchr="",glgObj.clss="",glgObj.voca=[],dataErrorMOD()}docEl("slctdTchrTxt").textContent=glgObj.clss+" "+glgObj.tchr+" "+glgObj.frag,makeGameQstns()}else dataErrorMOD();renderNav(),handlersOn()}function userScored(scr){var score,timeStamp,duration;scr>0&&(score="highscore: "+scr,duration=(timeStamp=Date.now())-glgObj.time,postIt({a:timeStamp,b:glgObj.tchr,c:glgObj.clss,d:glgObj.frag,e:duration,f:document.title,g:score}))}function postIt(dataObj){var user=firebase.auth().currentUser,uid=user.uid,postData={email:user.email,timestamp:dataObj.a,tchr:dataObj.b,clss:dataObj.c,frag:dataObj.d,duration:dataObj.e,activity:dataObj.f,score:dataObj.g},newPostKey,updates={};updates["activities/"+uid+"/"+firebase.database().ref().child("activities/"+uid+"/").push().key]=postData,firebase.database().ref().update(updates,(function(e){e?"PERMISSION_DENIED"===e.code?signOutOfApp():window.alert("Data could not be saved.\n"+e):window.alert("Activity completed!")}))}firebase.auth().onAuthStateChanged((function(user){user?(docEl("usrPhoto").src=user.photoURL,init()):window.location="../index.html"}))}()}));