window.addEventListener("load",(function(){!function(){"use strict";var appEditor={tempIdxArr:[],users:{tchrs:{},pending:{},removed:{},absentPending:{}}};function chkPermission(e){"PERMISSION_DENIED"===e.code&&signOutOfApp()}function signOutOfApp(){firebase.auth().signOut()}function docEl(id){return document.getElementById(id)}function showEl(elId){docEl(elId).className=docEl(elId).className.replace(/(?:^|\s)nodisplay(?!\S)/g,"")}function emptyContent(parentEl){for(;parentEl.hasChildNodes();){for(;parentEl.lastChild.hasChildNodes();)parentEl.lastChild.removeChild(parentEl.lastChild.lastChild);parentEl.removeChild(parentEl.lastChild)}}function getAllUsers(){var bossUid=firebase.auth().currentUser.uid,tchrArr,len;firebase.database().ref("tchrList/pe4/pe4TchrIndex").once("value").then((function(snapshot){if(-1===(tchrArr=snapshot.val()||[]).indexOf(bossUid)&&tchrArr.unshift(bossUid),0===(len=tchrArr.length-1))return appEditor.users.tchrs[bossUid]={name:firebase.auth().currentUser.displayName,isMod:!0},void getAllPending();tchrArr.forEach((function(el,i){getEachTchr(el,i,len)}))}),(function(e){chkPermission(e)}))}function getEachTchr(el,i,len){firebase.database().ref("tchrList/pe4/"+el).once("value").then((function(snapshot){null!==snapshot.val()&&(appEditor.users.tchrs[el]=snapshot.val()),i===len&&getAllPending()}),(function(e){chkPermission(e)}))}function getAllPending(){firebase.database().ref("newUser/pe4").once("value").then((function(snapshot){appEditor.users.pending=snapshot.val()||{},buildBossOpts()}),(function(e){chkPermission(e)}))}function toggleTchrBtnClass(el){return el.classList.contains("btn-success")?(el.className=el.className.replace(/(?:^|\s)btn-success(?!\S)/g,""),el.className+=" btn-primary",void(el.dataset.isMod="yes")):el.classList.contains("btn-primary")?(el.className=el.className.replace(/(?:^|\s)btn-primary(?!\S)/g,""),el.className+=" btn-default",void(el.dataset.isMod="no")):(el.className=el.className.replace(/(?:^|\s)btn-default(?!\S)/g,""),el.className+=" btn-success",void(el.dataset.isMod="no"))}function updateUsersDb(){var updates={},currentUids=Object.keys(appEditor.users.tchrs),pendingUids=Object.keys(appEditor.users.pending),absentPendingUids=Object.keys(appEditor.users.absentPending);currentUids.forEach((function(uid){updates["tchrList/pe4/"+uid]=appEditor.users.tchrs[uid],updates["tchrList/pe4/pe4TchrIndex"]=Object.keys(appEditor.users.tchrs)})),pendingUids.forEach((function(uid){updates["newUser/pe4/"+uid]=appEditor.users.pending[uid]})),absentPendingUids.forEach((function(uid){updates["newUser/pe4/"+uid]=null})),firebase.database().ref().update(updates,(function(e){e?(chkPermission(e),window.mscAlert({title:"",subtitle:"Data could not be updated.\n"+e})):(window.mscAlert({title:"",subtitle:"Changes saved!"}),appEditor.users.absentPending={},buildBossOpts())}))}function unrepresentedUsersPending(pendingEls,pendObj){var currentPendUids=Object.keys(pendObj),futurePendObj={},returnObj={};return pendingEls.forEach((function(el){futurePendObj[el.dataset.uid]=el.dataset.name})),currentPendUids.forEach((function(el){futurePendObj.hasOwnProperty(el)||(returnObj[el]=pendObj[el])})),returnObj}function optsUpdateUsers(){var pendObj=JSON.parse(JSON.stringify(appEditor.users.pending)),bossUid=firebase.auth().currentUser.uid,container=docEl("manageOpts"),pendingEls=Array.from(container.querySelectorAll("div.btn.btn-default")),tchrEls,moderatorEls,futureUserEls=[Array.from(container.querySelectorAll("div.btn.btn-success")),Array.from(container.querySelectorAll("div.btn.btn-primary"))].reduce((function(acc,val){return acc.concat(val)}),[]);appEditor.users.absentPending=unrepresentedUsersPending(pendingEls,pendObj),appEditor.users.removed=[],appEditor.users.tchrs={},appEditor.users.pending={},futureUserEls.forEach((function(el){appEditor.users.tchrs[el.dataset.uid]={},appEditor.users.tchrs[el.dataset.uid].name=el.dataset.name,"yes"!==el.dataset.isMod&&el.dataset.uid!==bossUid||(appEditor.users.tchrs[el.dataset.uid].isMod=!0)})),pendingEls.forEach((function(el){el.dataset.uid===bossUid?(appEditor.users.tchrs[el.dataset.uid]={},appEditor.users.tchrs[el.dataset.uid].name=el.dataset.name,appEditor.users.tchrs[el.dataset.uid].isMod=!0):appEditor.users.pending[el.dataset.uid]=el.dataset.name})),updateUsersDb()}function chkForRemovedAccess(){var bossUid=firebase.auth().currentUser.uid,container=docEl("manageOpts"),tchrEls=Array.from(container.querySelectorAll("div.btn.btn-success")).map((function(el){return el.dataset.uid})),modEls=Array.from(container.querySelectorAll("div.btn.btn-primary")).map((function(el){return el.dataset.uid})),currentUids=Object.keys(appEditor.users.tchrs),futureUids=[tchrEls,modEls].reduce((function(acc,val){return acc.concat(val)}),[]);-1===futureUids.indexOf(bossUid)&&futureUids.push(bossUid),appEditor.users.removed=currentUids.filter((function(el){return-1===futureUids.indexOf(el)})),appEditor.users.removed.length?window.mscConfirm({title:"Warning",subtitle:"This action will remove access for some current users. Are you sure?",cancelText:"Exit",onOk:function(){promptRemovedUserData()},onCancel:function(){}}):optsUpdateUsers()}function promptRemovedUserData(){window.mscConfirm({title:"",subtitle:"Do you also want to delete any previous exams created by users with removed access?",cancelText:"No",onOk:function(){removeCurrentUsersData(!0)},onCancel:function(){removeCurrentUsersData(!1)}})}function removeCurrentUsersData(bool){var uidArr=appEditor.users.removed,updates={};uidArr.forEach((function(uid){!0===bool&&(updates["data/pe4/"+uid+"/examObjs"]=null),updates["tchrList/pe4/"+uid]=null})),firebase.database().ref().update(updates,(function(e){e?(chkPermission(e),window.mscAlert({title:"",subtitle:"User data could not be removed.\n"+e})):optsUpdateUsers()}))}function purgePendingFromDb(){var updates={},pendingArr;Object.keys(appEditor.users.pending).forEach((function(el){updates["newUser/pe4/"+el]=null})),firebase.database().ref().update(updates,(function(e){e?(chkPermission(e),window.mscAlert({title:"",subtitle:"Users awaiting access could not be deleted.\n"+e})):(window.mscAlert({title:"",subtitle:"No users awaiting access!"}),appEditor.users.pending={},buildBossOpts())}))}function optsDeletePending(){window.mscConfirm({title:"Warning",subtitle:"This action will delete the login attempts of all users awaiting access to the app. Proceed?",cancelText:"Exit",onOk:function(){purgePendingFromDb()},onCancel:function(){}})}function optsRevertUsers(){getAllUsers()}function identifyOptsUser(el){el.target!==el.currentTarget&&("DIV"===el.target.nodeName&&void 0!==el.target.dataset.uid&&toggleTchrBtnClass(el.target),el.stopPropagation())}function buildBossOpts(){var bossUid=firebase.auth().currentUser.uid,container=docEl("manageOpts"),frag=document.createDocumentFragment(),tchrKeys=Object.keys(appEditor.users.tchrs),pendKeys=Object.keys(appEditor.users.pending),userDiv,pendDiv;emptyContent(container),tchrKeys.forEach((function(el){(userDiv=document.createElement("div")).dataset.uid=el,userDiv.dataset.name=appEditor.users.tchrs[el].name,userDiv.dataset.isMod=!0===appEditor.users.tchrs[el].isMod?"yes":"no",userDiv.textContent=appEditor.users.tchrs[el].name+"\n"+el,bossUid===el?(userDiv.dataset.isMod="yes",userDiv.className="btn btn-sm btn-primary btn-fixwidth",userDiv.style.display="none",userDiv.style.visibility="hidden"):"yes"===userDiv.dataset.isMod?userDiv.className="btn btn-sm btn-primary btn-fixwidth":userDiv.className="btn btn-sm btn-success btn-fixwidth",frag.appendChild(userDiv)})),pendKeys.forEach((function(el){(pendDiv=document.createElement("div")).className="btn btn-sm btn-default btn-fixwidth",pendDiv.dataset.uid=el,pendDiv.dataset.name=appEditor.users.pending[el],userDiv.dataset.isMod="no",pendDiv.textContent=appEditor.users.pending[el]+"\n"+el,frag.appendChild(pendDiv)})),container.appendChild(frag),showEl("manageOpts"),showEl("optActions")}function handlersOn(){docEl("manageOpts").addEventListener("click",identifyOptsUser,{capture:!1,passive:!0}),docEl("updateUsers").addEventListener("click",chkForRemovedAccess,{capture:!1,passive:!0}),docEl("deleteUsers").addEventListener("click",optsDeletePending,{capture:!1,passive:!0}),docEl("revertUsers").addEventListener("click",optsRevertUsers,{capture:!1,passive:!0}),docEl("logout").addEventListener("click",signOutOfApp,{capture:!1,passive:!0})}firebase.auth().onAuthStateChanged((function(user){user?(docEl("usrPhoto").src=user.photoURL,getAllUsers(),handlersOn(),showEl("contentsBox"),showEl("screenButtons")):window.location="../index.html"}))}()}));